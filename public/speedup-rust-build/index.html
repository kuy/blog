<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title>sccacheでGitHub Actions上のRustビルドを高速化するやつ試した - blog.endflow.net</title>

      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
      

      
          <link href="https://fonts.googleapis.com/css?family=Roboto:400,700|Source+Code+Pro&display=swap" rel="stylesheet">
          <link rel="stylesheet" href="https://blog.endflow.net/site.css">
          
      

      <!-- Global site tag (gtag.js) - Google Analytics -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3511180-1"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-3511180-1');
      </script>

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">&#x2F;* blog.endflow.net *&#x2F;</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.endflow.net&#x2F;categories">
                            Categories
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.endflow.net&#x2F;tags">
                            Tags
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.endflow.net&#x2F;about">
                            @kuy
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;blog.endflow.net">&#x2F;* blog.endflow.net *&#x2F;</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.endflow.net&#x2F;categories">
                                    Categories
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.endflow.net&#x2F;tags">
                                    Tags
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.endflow.net&#x2F;about">
                                    @kuy
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    



<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;blog.endflow.net&#x2F;speedup-rust-build&#x2F;">sccacheでGitHub Actions上のRustビルドを高速化するやつ試した</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2021-04-26</span>
            
        </div>
    </header>

    <div class="post-content">
      <h2 id="rust-puroziekutonobirudosu-du">Rust プロジェクトのビルド速度</h2>
<p>ご存知の通り、Rust のコンパイル速度は遅い。まぁそれだけ高級なことをやっているんだから仕方ないとは思う。
それに<a href="https://perf.rust-lang.org/dashboard.html">パフォーマンスダッシュボード</a>を見てみると着実に改善していてすごい。</p>
<p>とはいえ、現実にはその遅さによって微妙な待ちが発生してしまうのは事実。何とかならないかな・・・と思っていたら <a href="https://www.fluvio.io/blog/2021/04/github-actions-best-practices/">「GitHub Actions best practices for Rust projects」</a> という記事を見つけた。</p>
<p>記事自体のテーマは GitHub Actions における Rust プロジェクトだけど、そのうちの１つはビルド速度の改善。</p>
<p>これはうってつけだ！ということで早速趣味プロジェクトの CI に導入して試してみた。</p>
<span id="continue-reading"></span><h2 id="jie-lun-2-bei-zao-kunatuta">結論: 2 倍早くなった</h2>
<p>忙しい人のために結論から言うと 2 倍も早くなった。 crate のダウンロードキャッシュなども導入することでさらに早くなりそう。</p>
<h2 id="github-actions-no-workflow">GitHub Actions の workflow</h2>
<p>記事の内容だとそのまま動かない部分があったので、とりあえず workflow を掲載しておく。</p>
<pre data-lang="yml" class="language-yml "><code class="language-yml" data-lang="yml">name: Build

on:
  push:

jobs:
  build:
    name: Build
    runs-on: ubuntu-20.04
    env:
      RUSTC_WRAPPER: sccache
      SCCACHE_CACHE_SIZE: 1G
      SCCACHE_DIR: /home/runner/.cache/sccache
      # SCCACHE_RECACHE: 1 # Uncomment this to clear cache, then comment it back out
    steps:
      - uses: actions/checkout@v2
      - name: Install sccache
        env:
          LINK: https://github.com/mozilla/sccache/releases/download
          SCCACHE_VERSION: 0.2.15
        run: |
          SCCACHE_FILE=sccache-v$SCCACHE_VERSION-x86_64-unknown-linux-musl
          mkdir -p $HOME/.local/bin
          curl -L "$LINK/v$SCCACHE_VERSION/$SCCACHE_FILE.tar.gz" | tar xz
          mv -f $SCCACHE_FILE/sccache $HOME/.local/bin/sccache
          chmod +x $HOME/.local/bin/sccache
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: 1.51.0
          override: true
      - name: Prepare sccache
        uses: actions/cache@v2
        continue-on-error: false
        with:
          path: /home/runner/.cache/sccache
          key: ${{ runner.os }}-sccache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-sccache-
      - name: Start sccache server
        run: sccache --start-server
      - name: Build
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release
      - name: Print sccache stats
        run: sccache --show-stats
      - name: Stop sccache server
        run: sccache --stop-server || true
</code></pre>
<p>変更点としては、</p>
<ul>
<li>最新の <code>0.2.15</code> だと GitHub 上でのタグ付けフォーマットが変わった
<ul>
<li><code>v</code> が入るようになった</li>
</ul>
</li>
<li>ダウンロードした <code>sccache</code> の実行ファイルに権限付与</li>
</ul>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="https://blog.endflow.net/tags/rust/">#rust</a>
                    
                        <a href="https://blog.endflow.net/tags/optimization/">#optimization</a>
                    
                        <a href="https://blog.endflow.net/tags/sccache/">#sccache</a>
                    
                        <a href="https://blog.endflow.net/tags/tool/">#tool</a>
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;blog.endflow.net&#x2F;bike-upgrade-202104&#x2F;">‹ CHAPTER2 TEREのアップグレード - 2021年4月</a>
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;blog.endflow.net&#x2F;hanno-ride&#x2F;">飯能通行止めライド ›</a>
                    
                    
                    
                </div>
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https://blog.endflow.net/even.js" ></script>
      
    </body>

</html>
